name: IPTVè‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 0 * * 2'  # æ¯å‘¨äºŒUTC 0ç‚¹
  workflow_dispatch:

jobs:
  update-iptv:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        persist-credentials: true
        
    - name: è®¾ç½®è„šæœ¬æƒé™
      run: chmod +x scripts/iptv_updater.sh
      
    - name: è¿è¡ŒIPTVæ›´æ–°è„šæœ¬
      run: |
        # è¿›å…¥è„šæœ¬ç›®å½•å¹¶è¿è¡Œ
        cd scripts
        ./iptv_updater.sh
      env:
        INPUT_UDPXY_HOST: "192.168.10.2"
        INPUT_UDPXY_PORT: "4022"
        
    - name: éªŒè¯æ–‡ä»¶ç”Ÿæˆ
      run: |
        echo "æ£€æŸ¥å½“å‰ç›®å½•ç»“æ„:"
        pwd
        ls -la
        echo "æ£€æŸ¥docsç›®å½•:"
        ls -la docs/ || echo "docsç›®å½•ä¸å­˜åœ¨"
        echo "æ£€æŸ¥scriptsç›®å½•:"
        ls -la scripts/
        
    - name: ç§»åŠ¨æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
      run: |
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦åœ¨scriptsç›®å½•ä¸‹ç”Ÿæˆäº†docs
        if [ -d "scripts/docs" ]; then
          echo "åœ¨scriptsç›®å½•ä¸‹æ‰¾åˆ°docsï¼Œç§»åŠ¨åˆ°æ ¹ç›®å½•"
          cp -r scripts/docs/* docs/ 2>/dev/null || true
        fi
        
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦åœ¨scriptsç›®å½•ç”Ÿæˆäº†æ–‡ä»¶
        if ls scripts/*.m3u8 scripts/*.log scripts/*.json scripts/*.html 1> /dev/null 2>&1; then
          echo "åœ¨scriptsç›®å½•æ‰¾åˆ°è¾“å‡ºæ–‡ä»¶ï¼Œç§»åŠ¨åˆ°docs"
          mkdir -p docs
          mv scripts/*.m3u8 scripts/*.log scripts/*.json scripts/*.html docs/ 2>/dev/null || true
        fi
        
    - name: åˆ›å»ºdocsç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      run: |
        mkdir -p docs
        # åˆ›å»ºæµ‹è¯•æ–‡ä»¶ä»¥ç¡®ä¿ç›®å½•ä¸ä¸ºç©º
        if [ ! -f "docs/test.txt" ]; then
          echo "æµ‹è¯•æ–‡ä»¶ - å¦‚æœçœ‹åˆ°è¿™ä¸ªï¼Œè¯´æ˜è„šæœ¬æ²¡æœ‰æ­£å¸¸ç”Ÿæˆæ–‡ä»¶" > docs/test.txt
        fi
        
    - name: é…ç½®Gitç”¨æˆ·
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
    - name: æäº¤æ›´æ–°æ–‡ä»¶
      run: |
        # ç¡®ä¿docsç›®å½•æœ‰å†…å®¹
        if [ -d "docs" ] && [ "$(ls -A docs 2>/dev/null | wc -l)" -gt 0 ]; then
          git add docs/
          git status
          git commit -m "ğŸ“º IPTVè‡ªåŠ¨æ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S')" || echo "æ— æ›´æ”¹"
          git push origin main
          echo "âœ… æ–‡ä»¶å·²æäº¤"
        else
          echo "âŒ docsç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          # åˆ—å‡ºæ ¹ç›®å½•æ‰€æœ‰æ–‡ä»¶
          echo "æ ¹ç›®å½•å†…å®¹:"
          ls -la
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          exit 1
        fi
        
    - name: éƒ¨ç½²åˆ°GitHub Pages
      if: success()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages
        force_orphan: true
        keep_files: false
